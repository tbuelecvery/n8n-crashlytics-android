---
name: n8n-reboot-recovery
description: Recover a local n8n Crashlytics automation stack after a PC reboot by restarting Docker Compose services, recreating a Cloudflare quick tunnel, and rebuilding the active webhook URL. Use when the user says reboot/restart happened, webhook delivery stopped, tunnel URL changed, or they want one-shot recovery plus explicit manual follow-up steps.
---

# n8n Reboot Recovery

Execute a deterministic reboot recovery flow for this project and return both automated results and required manual actions.

## Runbook

1. Run the bundled script:

```bash
AUTO_INSTALL_DEPS=true scripts/recover_after_reboot.sh [repo_path] [triage_workflow_id] [slack_events_workflow_id]
```

- Defaults:
- `repo_path`: `/Users/tbu/Documents/n8n-crashlytics-android`
- `triage_workflow_id`: `QjqFiU4AS3RetyYG`
- `slack_events_workflow_id`: `rz4ofhodZWIBPTBu`
- `AUTO_INSTALL_DEPS=true`: install missing `docker`/`cloudflared` with Homebrew when possible
- Optional: `WAIT_N8N_SECONDS` (default `90`) to tolerate slow n8n startup after container recreate
- Optional: `START_TUNNEL=true` (default) starts cloudflared quick tunnel automatically
- Optional: `WAIT_TUNNEL_SECONDS` (default `45`) wait window for tunnel URL detection

2. Parse script output keys and report:
- `STATUS=ok` means automated steps succeeded.
- `DOCKER_INSTALLED_NOW` and `CLOUDFLARED_INSTALLED_NOW` indicate whether dependencies were installed during this run.
- `ENV_PLACEHOLDER_KEYS` lists unresolved placeholder keys in `.env` (key names only, no values).
- `BIGQUERY_CONFIGURED`, `BIGQUERY_READY`, `BIGQUERY_MISSING_KEYS` show BigQuery polling readiness.
- `WEBHOOK_PATH_SLACK_EVENTS` is the active n8n webhook suffix for Slack Event Subscriptions.
- `WEBHOOK_PATH` remains for backward compatibility.
- `TUNNEL_URL` is auto-generated by the script when `START_TUNNEL=true`.
- `WEBHOOK_URL_SLACK_EVENTS` is ready-to-use full URL for Slack Request URL.
- `TUNNEL_LOG` is the cloudflared log file path for diagnostics.
- `TUNNEL_COMMAND` is the command to open a new quick tunnel.
- `MANUAL_1`..`MANUAL_4` are user actions that cannot be automated.

3. Tunnel handling:
- Default behavior: script starts quick tunnel automatically and prints `TUNNEL_URL` + `WEBHOOK_URL_SLACK_EVENTS`.
- If user wants manual tunnel operation, run with `START_TUNNEL=false` and use `TUNNEL_COMMAND`.
- For Codex execution reliability, always validate tunnel reachability (`/healthz`).
- If tunnel URL is missing/unreachable, start `TUNNEL_COMMAND` in a persistent PTY session and rebuild `WEBHOOK_URL_SLACK_EVENTS`.

4. Always include manual next steps in the user message after automation:
- Update Slack App Event Subscriptions Request URL to `WEBHOOK_URL_SLACK_EVENTS`.
- Reinstall Slack app if scopes/events changed, then invite bot to target channel.
- Confirm new execution appears in n8n after test event delivery.
- If `BIGQUERY_READY=false`, guide user to fill missing keys from `BIGQUERY_MISSING_KEYS`.

## Failure handling

If script fails, follow this order:
1. If error says Homebrew missing, install Homebrew first.
2. If error says Docker daemon not running, launch Docker Desktop and wait until `docker info` succeeds.
3. If n8n startup is slow, re-run with larger wait:
   - `WAIT_N8N_SECONDS=180 AUTO_INSTALL_DEPS=true scripts/recover_after_reboot.sh ...`
4. If tunnel still fails, re-run with larger wait:
   - `WAIT_TUNNEL_SECONDS=90 AUTO_INSTALL_DEPS=true scripts/recover_after_reboot.sh ...`
5. If needed, bypass tunnel auto-start:
   - `START_TUNNEL=false AUTO_INSTALL_DEPS=true scripts/recover_after_reboot.sh ...`
   - Then run `TUNNEL_COMMAND` manually.

## Notes

- Cloudflare quick tunnel domains change after restart; treat old domains as stale.
- Keep cloudflared running in a live terminal/PTY session; do not rely on one-shot background jobs.
- Keep secrets out of logs and user-facing output.
